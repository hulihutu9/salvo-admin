<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "https://raw.githubusercontent.com/rbatis/rbatis/master/rbatis-codegen/mybatis-3-mapper.dtd">
<mapper>
    <select id="get_gen_table_page">
        `select table_id, table_name, table_comment, sub_table_name, sub_table_fk_name, class_name,
        tpl_category, package_name, module_name, business_name, function_name,
        function_author, gen_type, gen_path, options, create_by, create_time, update_by, update_time,
        remark from gen_table`
        <where>
            1 = 1
            <if test="table_name != '' && table_name != null">
                ` and table_name = #{table_name}`
            </if>
            <if test="table_comment != '' && table_comment != null ">
                ` and table_comment = #{table_comment}`
            </if>
            <if test="begin_time != '' && begin_time != null">
                ` and su.create_time between #{begin_time} and #{end_time}`
            </if>
            ` limit #{page_num},#{page_size}`
        </where>
    </select>
    <select id="get_gen_table_by_id">
        `select table_id, table_name, table_comment, sub_table_name, sub_table_fk_name, class_name,
        tpl_category, package_name, module_name, business_name, function_name,
        function_author, gen_type, gen_path, options, create_by, create_time, update_by, update_time,
        remark from gen_table`
        <where>
            `table_id = #{table_id}`
        </where>
    </select>
    <select id="get_gen_table_by_name">
        `select table_id, table_name, table_comment, sub_table_name, sub_table_fk_name, class_name,
        tpl_category, package_name, module_name, business_name, function_name,
        function_author, gen_type, gen_path, options, create_by, create_time, update_by, update_time,
        remark from gen_table`
        <where>
            `table_name = #{table_name}`
        </where>
    </select>
    <select id="get_gen_table_all">
        `SELECT t.table_id, t.table_name, t.table_comment, t.sub_table_name, t.sub_table_fk_name, t.class_name,
        t.tpl_category, t.package_name, t.module_name, t.business_name, t.function_name,
        t.function_author, t.options, t.remark,
        c.column_id, c.column_name, c.column_comment, c.column_type, c.java_type, c.java_field, c.is_pk, c.is_increment,
        c.is_required, c.is_insert, c.is_edit, c.is_list, c.is_query, c.query_type, c.html_type, c.dict_type, c.sort
        FROM gen_table t
        LEFT JOIN gen_table_column c ON t.table_id = c.table_id
        order by c.sort`
    </select>
    <select id="get_gen_table_count">
        `select count(*) from gen_table`
        <where>
            1 = 1
            <if test="table_name != '' && table_name != null">
                ` and table_name = #{table_name}`
            </if>
            <if test="table_comment != '' && table_comment != null">
                ` and table_comment = #{table_comment}`
            </if>
            <if test="begin_time != '' && begin_time != null">
                ` and su.create_time between #{begin_time} and #{end_time}`
            </if>
        </where>
    </select>
    <delete id="del_gen_table_by_id">
        `delete from gen_table`
        <where>
            `1 = 1 and table_id in ( ${table_id} )`
        </where>
    </delete>
    <delete id="del_gen_table_column_by_id">
        `delete from gen_table_column`
        <where>
            `1 = 1 and table_id in ( ${table_id} )`
        </where>
    </delete>
    <select id="get_gen_table_list">
        `select * from gen_table`
    </select>
    <select id="get_db_table_page">
        `select table_name, table_comment, create_time, update_time from information_schema.tables
        where table_schema = (select database())
        AND table_name NOT LIKE 'qrtz\_%' AND table_name NOT LIKE 'gen\_%'
        AND table_name NOT IN (select table_name from gen_table)`
        <if test="table_name != null && table_name != ''">
            ` AND lower(table_name) like lower(concat('%', #{table_name}, '%'))`
        </if>
        <if test="table_comment != null && table_comment != ''">
            ` AND lower(table_comment) like lower(concat('%', #{table_comment}, '%'))`
        </if>
        ` order by create_time desc limit #{page_num},#{page_size}`
    </select>
    <select id="get_db_table_count">
        `select count(*) from information_schema.tables
        where table_schema = (select database())
        AND table_name NOT LIKE 'qrtz\_%' AND table_name NOT LIKE 'gen\_%'
        AND table_name NOT IN (select table_name from gen_table)`
        <if test="table_name != null && table_name != ''">
            ` AND lower(table_name) like lower(concat('%', #{table_name}, '%'))`
        </if>
        <if test="table_comment != null && table_comment != ''">
            ` AND lower(table_comment) like lower(concat('%', #{table_comment}, '%'))`
        </if>
    </select>
    <select id="get_db_table_by_names">
        `select table_name, table_comment, create_time, update_time from information_schema.tables
        where table_schema = (select database())
        AND table_name NOT LIKE 'qrtz\_%' AND table_name NOT LIKE 'gen\_%'
        AND table_name IN `
        <foreach collection="names" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    <select id="get_db_table_columns_by_name">
        `select COLUMN_NAME,
        (case when (is_nullable = 'no' and column_key != 'PRI') then '1' else '0' end) as IS_REQUIRED,
        (case when column_key = 'PRI' then '1' else '0' end) as IS_PK,
        ordinal_position as SORT, COLUMN_COMMENT,
        (case when extra = 'auto_increment' then '1' else '0' end) as IS_INCREMENT, COLUMN_TYPE
        from information_schema.columns where table_schema = (select database()) and table_name = #{table_name}
        order by ordinal_position`
    </select>
    <update id="updateGenTable">
        update gen_table
        <set>
            <if test="tableName != null">table_name = #{tableName},</if>
            <if test="tableComment != null and tableComment != ''">table_comment = #{tableComment},</if>
            <if test="subTableName != null">sub_table_name = #{subTableName},</if>
            <if test="subTableFkName != null">sub_table_fk_name = #{subTableFkName},</if>
            <if test="className != null and className != ''">class_name = #{className},</if>
            <if test="functionAuthor != null and functionAuthor != ''">function_author = #{functionAuthor},</if>
            <if test="genType != null and genType != ''">gen_type = #{genType},</if>
            <if test="genPath != null and genPath != ''">gen_path = #{genPath},</if>
            <if test="tplCategory != null and tplCategory != ''">tpl_category = #{tplCategory},</if>
            <if test="tplWebType != null and tplWebType != ''">tpl_web_type = #{tplWebType},</if>
            <if test="packageName != null and packageName != ''">package_name = #{packageName},</if>
            <if test="moduleName != null and moduleName != ''">module_name = #{moduleName},</if>
            <if test="businessName != null and businessName != ''">business_name = #{businessName},</if>
            <if test="functionName != null and functionName != ''">function_name = #{functionName},</if>
            <if test="options != null and options != ''">options = #{options},</if>
            <if test="updateBy != null and updateBy != ''">update_by = #{updateBy},</if>
            <if test="remark != null">remark = #{remark},</if>
            update_time = sysdate()
        </set>
        where table_id = #{tableId}
    </update>
    <select id="get_gen_table_column_list_by_ids">
        select * from gen_table_column where table_id in
        <foreach collection="table_ids" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    <select id="get_gen_table_column_by_id">
        select column_id, table_id, column_name, column_comment, column_type, java_type, java_field, is_pk, is_increment,
        is_required, is_insert, is_edit, is_list, is_query, query_type, html_type, dict_type, sort, create_by,
        create_time, update_by, update_time from gen_table_column
        where table_id = #{table_id}
        order by sort
    </select>
</mapper>